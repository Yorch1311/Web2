!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/router"),require("rxjs"),require("rxjs/operators"),require("@angular/common")):"function"==typeof define&&define.amd?define("@scullyio/ng-lib",["exports","@angular/core","@angular/router","rxjs","rxjs/operators","@angular/common"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).scullyio=t.scullyio||{},t.scullyio["ng-lib"]={}),t.ng.core,t.ng.router,t.rxjs,t.rxjs.operators,t.ng.common)}(this,(function(t,e,n,r,i,o){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function s(t,e,n,r){return new(n||(n=Promise))((function(i,o){function s(t){try{a(r.next(t))}catch(t){o(t)}}function u(t){try{a(r.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,u)}a((r=r.apply(t,e||[])).next())}))}function u(t,e){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function u(o){return function(u){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,u])}}}Object.create;function a(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}Object.create;var c={useTransferState:!0,alwaysMonitor:!1,manualIdle:!1,baseURIForScullyContent:"http://localhost:1668"},l=new e.InjectionToken("scullyLibConfig",{factory:function(){return c}}),p=function(t){return t.includes("#")&&(t=t.split("#")[0]),t.includes("?")&&(t=t.split("?")[0]),t.endsWith("/")?t.slice(0,-1):t};function f(t,e){return void 0===e&&(e="json"),new Promise((function(n,r){var i=new XMLHttpRequest;i.responseType=e,i.addEventListener("load",(function(t){if(200!==i.status)return r(i);n(i.response)})),i.addEventListener("error",(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return r(t)})),i.open("get",t,!0),i.send()}))}var h=function(){return window&&"running"===window.ScullyIO},d=function(){return window&&"generated"===window.ScullyIO};function y(t,e){return t.endsWith("/")&&e.startsWith("/")?""+t+e.substr(1):t.endsWith("/")||e.startsWith("/")?""+t+e:t+"/"+e}var v="ScullyIO-transfer-state",g="/** ___SCULLY_STATE_START___ */",m="/** ___SCULLY_STATE_END___ */";var b=function(){function t(t,e){var o=this;this.document=t,this.router=e,this.inlineOnly=!1,this.currentBaseUrl="//",this.stateBS=new r.BehaviorSubject({}),this.state$=this.stateBS.pipe(i.filter((function(t){return void 0!==t}))),this.nextUrl=this.router.events.pipe(i.filter((function(t){return t instanceof n.NavigationStart})),i.switchMap((function(t){return p(o.initialUrl)===p(t.url)?(o.initialUrl="__done__with__Initial__navigation__",r.NEVER):r.of(t)})),i.tap((function(){return o.stateBS.next(void 0)})),i.switchMap((function(t){return o.router.events.pipe(i.filter((function(e){return e instanceof n.NavigationEnd&&e.url===t.url})),i.first())})),i.map((function(t){return p(t.urlAfterRedirects||t.url)})),i.shareReplay(1))}return t.prototype.startMonitoring=function(){window&&window["ScullyIO-injected"]&&window["ScullyIO-injected"].inlineStateOnly&&(this.inlineOnly=!0),this.setupEnvForTransferState(),this.setupStartNavMonitoring()},t.prototype.setupEnvForTransferState=function(){if(h()){this.injectScript();var t=window["ScullyIO-exposed"]||{};t.transferState&&(this.stateBS.next(t.transferState),this.saveState(t.transferState))}else d()&&(this.initialUrl=window.location.pathname||"__no_NO_no__",this.initialUrl="/"!==this.initialUrl&&this.initialUrl.endsWith("/")?this.initialUrl.slice(0,-1):this.initialUrl,this.stateBS.next(window&&window[v]||{}))},t.prototype.injectScript=function(){this.script=this.document.createElement("script"),this.script.setAttribute("id",v);for(var t=document.body.lastChild;"SCRIPT"===t.previousSibling.nodeName;)t=t.previousSibling;document.body.insertBefore(this.script,t)},t.prototype.getState=function(t){return this.fetchTransferState(),this.state$.pipe(i.pluck(t))},t.prototype.stateHasKey=function(t){return this.stateBS.value&&this.stateBS.value.hasOwnProperty(t)},t.prototype.stateKeyHasValue=function(t){return this.stateBS.value&&this.stateBS.value.hasOwnProperty(t)&&null!=this.stateBS.value[t]},t.prototype.setState=function(t,e){var n,r=Object.assign(Object.assign({},this.stateBS.value),((n={})[t]=e,n));this.stateBS.next(r),this.saveState(r)},t.prototype.saveState=function(t){var e,n;h()&&(this.script.textContent="{window['"+v+"']=_u(`"+g+(e=JSON.stringify(t),n={"'":"_~q~",$:"_~o~","`":"_~b~","/":"_~s~","<":"_~l~",">":"_~g~"},e.replace(/[\$`'<>\/]/g,(function(t){return n[t]})).replace(/\\\"/g,"_~d~"))+m+"`);function _u(t){t=t.split('"+g+"')[1].split('"+m+"')[0];const u={'_~b~': \"`\",'_~q~': \"'\",'_~o~': '$','_~s~': '/','_~l~': '<','_~g~': '>'};return JSON.parse(t.replace(/_~d~/g,'\\\\\"').replace(/_~[^]~/g, (s) => u[s]).replace(/\\n/g,'\\\\n').replace(/\\t/g,'\\\\t').replace(/\\r/g,'\\\\r'));}}")},t.prototype.setupStartNavMonitoring=function(){d()&&this.nextUrl.subscribe()},t.prototype.useScullyTransferState=function(t,e){var n=this;return d()?this.getState(t):e.pipe(i.tap((function(e){return n.setState(t,e)})))},t.prototype.fetchTransferState=function(){return s(this,void 0,void 0,(function(){var t,e,n,o=this;return u(this,(function(s){switch(s.label){case 0:return t=function(t){return t.split("/").filter((function(t){return""!==t.trim()}))[0]},[4,new Promise((function(t){return setTimeout(t,0)}))];case 1:return s.sent(),[4,this.nextUrl.pipe(i.take(1)).toPromise()];case 2:return e=s.sent(),n=t(e),this.currentBaseUrl===n?[2]:(this.currentBaseUrl=n,this.nextUrl.pipe(i.takeWhile((function(e){return t(e)===o.currentBaseUrl})),i.switchMap((function(t){return o.inlineOnly?o.readFromIndex(t):o.readFromJson(t)})),i.catchError((function(t){return console.warn("Error while loading of parsing Scully state:",t),r.of({})})),i.tap((function(t){o.stateBS.next(t)}))).subscribe({complete:function(){o.currentBaseUrl="//"}}),[2])}}))}))},t.prototype.readFromJson=function(t){return f(w(y(t,"/data.json")))},t.prototype.readFromIndex=function(t){return f(w(y(t,"/index.html")),"text").then((function(t){var e,n=t.split(g)[1].split(m)[0];return JSON.parse((e={"_~q~":"'","_~b~":"`","_~o~":"$","_~s~":"/","_~l~":"<","_~g~":">"},n.replace(/_~d~/g,'\\"').replace(/_~[^]~/g,(function(t){return e[t]})).replace(/\n/g,"\\n").replace(/\r/g,"\\r")))}))},t}();function w(t){return t.startsWith("/")?t.slice(1):t}b.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],b.ctorParameters=function(){return[{type:Document,decorators:[{type:e.Inject,args:[o.DOCUMENT]}]},{type:n.Router}]},b.ɵprov=e.ɵɵdefineInjectable({factory:function(){return new b(e.ɵɵinject(o.DOCUMENT),e.ɵɵinject(n.Router))},token:b,providedIn:"root"});var S=function(){function t(t,e,o,s){var u=this;this.zone=t,this.router=e,this.initialUrl=_(window&&window.location&&window.location.pathname)||"",this.imState=new r.BehaviorSubject({idle:!1,timeOut:5e3}),this.idle$=this.imState.pipe(i.pluck("idle")),this.initApp=new Event("AngularInitialized",{bubbles:!0,cancelable:!1}),this.appReady=new Event("AngularReady",{bubbles:!0,cancelable:!1}),this.appTimeout=new Event("AngularTimeout",{bubbles:!0,cancelable:!1}),this.scullyLibConfig=Object.assign({},c,o);var a=!!(window["ScullyIO-exposed"]||{}).manualIdle;!this.scullyLibConfig.manualIdle&&window&&(this.scullyLibConfig.alwaysMonitor||h())&&(window.dispatchEvent(this.initApp),this.router.events.pipe(i.filter((function(t){return t instanceof n.NavigationEnd&&void 0!==t.urlAfterRedirects})),i.filter((function(t){return!a||t.urlAfterRedirects!==u.initialUrl})),i.tap((function(){return u.zoneIdleCheck()}))).subscribe()),this.scullyLibConfig.manualIdle&&window.dispatchEvent(this.initApp),this.scullyLibConfig.useTransferState&&s.startMonitoring()}return t.prototype.fireManualMyAppReadyEvent=function(){return s(this,void 0,void 0,(function(){return u(this,(function(t){return[2,window.dispatchEvent(this.appReady)]}))}))},t.prototype.init=function(){return s(this,void 0,void 0,(function(){return u(this,(function(t){return[2,this.idle$.pipe(i.take(1)).toPromise()]}))}))},t.prototype.zoneIdleCheck=function(){return s(this,void 0,void 0,(function(){var t,e=this;return u(this,(function(n){switch(n.label){case 0:return void 0===Zone||void 0===(t=Zone.current.get("TaskTrackingZone"))?[2,this.simpleTimeout()]:this.imState.value.idle?[4,this.setState("idle",!1)]:[3,2];case 1:n.sent(),n.label=2;case 2:return this.zone.runOutsideAngular((function(){var n,r=0,i=Date.now(),o=function(){clearTimeout(n),Date.now()-i>3e4?window.dispatchEvent(e.appTimeout):t.macroTasks.length>0&&void 0!==t.macroTasks.find((function(t){return t.source.includes("XMLHttpRequest")}))||r<1?n=setTimeout((function(){r+=1,o()}),50):e.zone.run((function(){setTimeout((function(){window.dispatchEvent(e.appReady),e.setState("idle",!0)}),250)}))};o()})),[2]}}))}))},t.prototype.simpleTimeout=function(){return s(this,void 0,void 0,(function(){var t=this;return u(this,(function(e){switch(e.label){case 0:return console.warn("Scully is using timeouts, add the needed polyfills instead!"),[4,new Promise((function(e){return setTimeout(e,t.imState.value.timeOut)}))];case 1:return e.sent(),window.dispatchEvent(this.appReady),[2]}}))}))},t.prototype.setPupeteerTimeoutValue=function(t){this.imState.next(Object.assign(Object.assign({},this.imState.value),{timeOut:t}))},t.prototype.setState=function(t,e){var n;this.imState.next(Object.assign(Object.assign({},this.imState.value),((n={})[t]=e,n)))},t}();function _(t){return t.endsWith("/")?t.slice(0,-1):t}S.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],S.ctorParameters=function(){return[{type:e.NgZone},{type:n.Router},{type:void 0,decorators:[{type:e.Inject,args:[l]}]},{type:b}]},S.ɵprov=e.ɵɵdefineInjectable({factory:function(){return new S(e.ɵɵinject(e.NgZone),e.ɵɵinject(n.Router),e.ɵɵinject(l),e.ɵɵinject(b))},token:S,providedIn:"root"});var T=function(){function t(t){this.router=t,this.refresh=new r.ReplaySubject(1),this.allRoutes$=this.refresh.pipe(i.switchMap((function(){return f("assets/scully-routes.json")})),i.catchError((function(){return console.warn("Scully routes file not found, are you running the Scully generated version of your site?"),r.of([])})),i.filter((function(t){return Array.isArray(t)})),i.map(this.cleanDups),i.shareReplay({refCount:!1,bufferSize:1})),this.available$=this.allRoutes$.pipe(i.map((function(t){return t.filter((function(t){return!t.hasOwnProperty("published")||!1!==t.published}))})),i.shareReplay({refCount:!1,bufferSize:1})),this.unPublished$=this.allRoutes$.pipe(i.map((function(t){return t.filter((function(t){return!!t.hasOwnProperty("published")&&!1===t.published}))})),i.shareReplay({refCount:!1,bufferSize:1})),this.topLevel$=this.available$.pipe(i.map((function(t){return t.filter((function(t){return!t.route.slice(1).includes("/")}))})),i.shareReplay({refCount:!1,bufferSize:1})),this.reload()}return t.prototype.getCurrent=function(){var t=this;return location?r.merge(r.of(new n.NavigationEnd(0,"","")),this.router.events).pipe(i.filter((function(t){return t instanceof n.NavigationEnd})),i.switchMap((function(){return t.available$})),i.map((function(t){var e=p(encodeURI(location.pathname).trim());return t.find((function(t){return e===p(t.route.trim())||t.slugs&&Array.isArray(t.slugs)&&t.slugs.find((function(t){return e.endsWith(p(t.trim()))}))}))}))):r.of()},t.prototype.cleanDups=function(t){var e=new Map;return t.forEach((function(t){return e.set(JSON.stringify(Object.assign(Object.assign({},t),{route:j(t)?"":t.route})),t)})),function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(a(arguments[e]));return t}(e.values())},t.prototype.reload=function(){this.refresh.next()},t}();function j(t){var e=Object.keys(t);return(1!==e.length||!e.includes("route"))&&(2!==e.length||!e.includes("route")||!e.includes("title"))}T.decorators=[{type:e.Injectable,args:[{providedIn:"root"}]}],T.ctorParameters=function(){return[{type:n.Router}]},T.ɵprov=e.ɵɵdefineInjectable({factory:function(){return new T(e.ɵɵinject(n.Router))},token:T,providedIn:"root"});var C,I=function(){function t(t,e,r,o,s){var u=this;this.elmRef=t,this.srs=e,this.router=r,this.location=o,this.conf=s,this.baseUrl=this.conf.useTransferState||c.useTransferState,this.elm=this.elmRef.nativeElement,this.routes=this.srs.allRoutes$.pipe(i.take(1)).toPromise(),this.routeUpdates$=this.router.events.pipe(i.filter((function(t){return t instanceof n.NavigationEnd})),i.filter((function(t){return C&&!C.endsWith(t.urlAfterRedirects)})),i.tap((function(t){return u.replaceContent()}))),this.routeSub=this.routeUpdates$.subscribe()}return t.prototype.ngOnInit=function(){this.elm&&this.handlePage()},t.prototype.handlePage=function(){return s(this,void 0,void 0,(function(){var t,n,r,i,o,s,a,c=this;return u(this,(function(u){switch(u.label){case 0:return t=p(location.href),C===t?[2]:(C=t,n=document.createElement("template"),r=this.getCSSId(this.elm),window.scullyContent?(i=window.scullyContent.html,r!==window.scullyContent.cssId?n.innerHTML=i.split(window.scullyContent.cssId).join(r):n.innerHTML=i,[3,3]):[3,1]);case 1:return[4,f(t+"/index.html","text").catch((function(t){if(e.isDevMode()){var n=new URL(location.href);return f(c.conf.baseURIForScullyContent+"/"+p(n.pathname)+"/index.html","text")}return Promise.reject(t)})).then((function(t){try{var e=t.split("\x3c!--scullyContent-begin--\x3e")[1].split("\x3c!--scullyContent-end--\x3e")[0];if(e.includes("_ngcontent")){var i="_ngcontent"+e.split("_ngcontent")[1].split("=")[0];n.innerHTML=e.split(i).join(r)}else n.innerHTML=e}catch(t){n.innerHTML='<h2 id="___scully-parsing-error___">Sorry, could not parse static page content</h2>\n            <p>This might happen if you are not using the static generated pages.</p>'}})).catch((function(t){n.innerHTML='<h2 id="___scully-parsing-error___">Sorry, could not load static page content</h2>',console.error("problem during loading static scully content",t)}))];case 2:u.sent(),u.label=3;case 3:return o=this.elm.parentElement||document.body,s=document.createComment("scullyContent-begin"),a=document.createComment("scullyContent-end"),o.insertBefore(s,this.elm),o.insertBefore(n.content,this.elm),o.insertBefore(a,this.elm),setTimeout((function(){return document.querySelectorAll("[href]").forEach(c.upgradeToRoutelink.bind(c))}),10),[2]}}))}))},t.prototype.upgradeToRoutelink=function(t){return s(this,void 0,void 0,(function(){var e,n,r,i,o,a=this;return u(this,(function(c){switch(c.label){case 0:return["A","BUTTON"].includes(t.tagName)?(e=t.dataset.hash)?(t.setAttribute("href","#"+e),t.setAttribute("onclick",""),t.onclick=function(t){t.preventDefault();var n=document.getElementById(e);if(n){var r=new URL(window.location.href);r.hash=e,history.replaceState("","",r.toString()),n.scrollIntoView()}},[2]):[4,this.routes]:[2];case 1:return n=c.sent(),r=t.getAttribute("href"),i=p(r.toLowerCase()),o=n.find((function(t){return p(t.route.toLowerCase())===i})),i&&o&&!i.startsWith("#")&&(t.onclick=function(t){return s(a,void 0,void 0,(function(){var e,n,r=this;return u(this,(function(i){switch(i.label){case 0:return e=o.route.split("/"),(n=location.pathname.split("/")).pop(),t.preventDefault(),[4,this.router.navigate(e).catch((function(t){return console.error("routing error",t),!1}))];case 1:return i.sent()?(n.every((function(t,n){return e[n]===t}))&&e.length!==n.length+1&&setTimeout((function(){return r.replaceContent()}),10),[2]):[2]}}))}))}),[2]}}))}))},t.prototype.replaceContent=function(){window.scullyContent=void 0;for(var t=this.elm.parentElement,e=function(t,e){for(var n,r=[],i=document.createNodeIterator(t,NodeFilter.SHOW_COMMENT,{acceptNode:function(t){return e&&t.nodeValue&&!t.nodeValue.includes(e)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}});n=i.nextNode();)r.push(n);return r}(t,"scullyContent-begin")[0];e&&e!==this.elm;){var n=e.nextSibling;t.removeChild(e),e=n}this.handlePage()},t.prototype.getCSSId=function(t){return t.getAttributeNames().find((function(t){return t.startsWith("_ngcontent")}))||""},t.prototype.ngOnDestroy=function(){this.routeSub.unsubscribe(),C="//"},t}();I.decorators=[{type:e.Component,args:[{selector:"scully-content",template:"<ng-content></ng-content>",changeDetection:e.ChangeDetectionStrategy.OnPush,encapsulation:e.ViewEncapsulation.None,preserveWhitespaces:!0,styles:["\n      :host {\n        display: none;\n      }\n      scully-content {\n        display: none;\n      }\n    "]}]}],I.ctorParameters=function(){return[{type:e.ElementRef},{type:T},{type:n.Router},{type:o.Location},{type:void 0,decorators:[{type:e.Inject,args:[l]}]}]};var R=function(){};R.decorators=[{type:e.NgModule,args:[{declarations:[I],exports:[I]}]}];var E=function(){function t(t){this.idle=t}return t.forRoot=function(e){return void 0===e&&(e=c),e=Object.assign({},c,e),{ngModule:t,providers:[{provide:l,useValue:e}]}},t}();E.decorators=[{type:e.NgModule,args:[{imports:[R],exports:[R]}]}],E.ctorParameters=function(){return[{type:S}]},t.IdleMonitorService=S,t.ScullyContentComponent=I,t.ScullyContentModule=R,t.ScullyLibModule=E,t.ScullyRoutesService=T,t.TransferStateService=b,t.dropEndingSlash=_,t.isScullyGenerated=d,t.isScullyRunning=h,t.ɵb=l,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=scullyio-ng-lib.umd.min.js.map